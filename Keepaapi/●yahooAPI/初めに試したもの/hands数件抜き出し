import requests
import pandas as pd
import time

# ğŸŒ¸ Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚° å•†å“æ¤œç´¢APIï¼ˆV3ï¼‰
API_URL = "https://shopping.yahooapis.jp/ShoppingWebService/V3/itemSearch"
APP_ID = "dj00aiZpPXlkOGd5bDlUcTlWRyZzPWNvbnN1bWVyc2VjcmV0Jng9MmE-"  # ã‚ãªãŸã®Client ID

# ğŸŒ· æ¤œç´¢è¨­å®š
SELLER_ID = "hands-net"         # æ±æ€¥ãƒãƒ³ã‚ºYahoo!åº—ã®ID
RESULTS_PER_CALL = 1           # 1å›ã§å–å¾—ã™ã‚‹ä»¶æ•°ï¼ˆæœ€å¤§50ï¼‰
TOTAL_ITEMS = 1                # åˆè¨ˆã§å–å¾—ã—ãŸã„ä»¶æ•°
CALLS = TOTAL_ITEMS // RESULTS_PER_CALL

all_rows = []

print("ğŸ” Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°APIã‹ã‚‰å•†å“æƒ…å ±ã‚’å–å¾—ä¸­...")

for i in range(CALLS):
    start = i * RESULTS_PER_CALL + 1

    # ğŸ”§ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    params = {
        "appid": APP_ID,
        "seller_id": SELLER_ID,
        "results": RESULTS_PER_CALL,
        "start": start,
        "sort": "-score",        # äººæ°—é †
        "condition": "new"       # æ–°å“
    }

    try:
        # ğŸ“¨ APIå‘¼ã³å‡ºã—
        response = requests.get(API_URL, params=params, timeout=10)
        data = response.json()
        hits = data.get("hits", [])
        if not hits:
            print(f"âš ï¸ {i+1}ãƒšãƒ¼ã‚¸ç›®ã«å•†å“ãªã—ã€‚")
            break

        for h in hits:
            name = h.get("name") or ""
            in_stock = h.get("inStock")  # True / False
            price = h.get("price") or ""
            jan = h.get("janCode") or ""
            all_rows.append([name, in_stock, price, jan])

        print(f"âœ… {i+1}ãƒšãƒ¼ã‚¸ç›®å®Œäº†ï¼ˆç´¯è¨ˆ: {len(all_rows)}ä»¶ï¼‰")

        time.sleep(0.5)

    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
        time.sleep(5)

# ğŸ“„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã—Excelã¸å‡ºåŠ›
df = pd.DataFrame(all_rows, columns=["å•†å“å", "åœ¨åº«ã‚ã‚Š", "ä¾¡æ ¼", "JANã‚³ãƒ¼ãƒ‰"])
output_path = "handsnet_å•†å“æƒ…å ±.xlsx"
df.to_excel(output_path, index=False)
 # æ¤œç´¢æ¡ä»¶ã«åˆè‡´ã—ãŸå•†å“ç·æ•°ï¼ˆã“ã“ã‚’ä½¿ã†ï¼‰

available = data.get("totalResultsAvailable")
print(f"ğŸ” å…¨ä½“ã®ãƒ’ãƒƒãƒˆä»¶æ•°: {available:,} ä»¶")
print("ğŸ‰ å®Œäº†ï¼Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚")
print(f"ğŸ“ ä¿å­˜å…ˆ: {output_path}")
